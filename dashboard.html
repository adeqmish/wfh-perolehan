<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard â€“ WFH</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--accent:#4da3ff;--ok:#34d399;--err:#ef4444}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#0b1020,#0e1429 40%,#0b1020);font-family:Inter,system-ui,Segoe UI,Arial;color:#e9eeff}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:40px;height:40px}
    .card{background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 30px 120px rgba(0,0,0,.5);width:min(92%,980px);margin:20px auto;padding:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .tile{background:#0c132a;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;text-decoration:none;color:#e9eeff;display:block}
    .tile:hover{border-color:#4da3ff}
    button{padding:10px 14px;border-radius:12px;border:0;background:var(--accent);color:#001333;font-weight:700;cursor:pointer}

    /* Modal styles */
    .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.6);backdrop-filter:blur(4px);z-index:60}
    .backdrop.show{display:flex}
    .modal{width:min(92%,480px);background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:0 30px 120px rgba(0,0,0,.6);padding:22px;transform:scale(.96);opacity:0;animation:pop .18s ease-out forwards}
    @keyframes pop{to{transform:scale(1);opacity:1}}
    .modal h3{margin:.2rem 0 .6rem;font-size:20px}
    label{display:block;margin:.6rem 0 .3rem;font-weight:600}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c132a;color:#e9eeff}
    .row{display:grid;gap:10px}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .muted{color:#b8c7ff;font-size:13px}
    .status{margin-top:8px;font-size:14px}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--err)}

    /* Small loading inline */
    .spinner{width:20px;height:20px;border-radius:50%;border:3px solid rgba(255,255,255,.18);border-top-color:var(--accent);animation:spin 1s linear infinite;display:none}
    .spinner.show{display:inline-block;margin-left:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://bursary.unisel.edu.my/wp-content/uploads/sites/15/2024/05/cropped-unisel-2.png" alt="UNISEL"/>
      <div>
        <div style="font-weight:700">WFH Dashboard</div>
        <small id="welcome"></small>
      </div>
    </div>
    <div>
      <button onclick="WFH.logout()">Logout</button>
    </div>
  </header>

  <main class="card">
    <h2>Menu</h2>
    <div class="grid">
      <a class="tile" href="uploader.html">ðŸ“„ Upload & Merge PO/PR</a>
      <a class="tile" href="#" onclick="alert('Coming soon')">ðŸ“¦ Inventory (coming soon)</a>
      <a class="tile" href="#" onclick="alert('Coming soon')">ðŸ“Š Reports (coming soon)</a>
      <a class="tile" href="#" id="openPwd">ðŸ”’ Tukar Kata Laluan</a>
    </div>
  </main>

  <!-- Modal Tukar Kata Laluan -->
  <div id="pwdBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="pwd-title">
    <div class="modal">
      <h3 id="pwd-title">Tukar Kata Laluan</h3>
      <p class="muted">Pastikan kata laluan baharu minimum 8 aksara.</p>
      <div class="row">
        <label for="currPwd">Kata Laluan Semasa</label>
        <input id="currPwd" type="password" autocomplete="current-password" />
        <label for="newPwd">Kata Laluan Baharu</label>
        <input id="newPwd" type="password" autocomplete="new-password" minlength="8" />
        <label for="newPwd2">Sahkan Kata Laluan Baharu</label>
        <input id="newPwd2" type="password" autocomplete="new-password" minlength="8" />
      </div>
      <div id="pwdStatus" class="status"></div>
      <div class="actions">
        <button type="button" id="pwdCancel">Batal</button>
        <button type="button" id="pwdSave">Simpan</button>
        <span id="pwdSpin" class="spinner" aria-hidden="true"></span>
      </div>
    </div>
  </div>

  <!-- auth.js -->
  <script src="auth.js?v=dashboard-2025-09-05"></script>
  <script>
    // Auth guard + greeting
    WFH.ensureAuth((res)=>{
      const name = localStorage.getItem('wfh_name') || res.email || 'User';
      document.getElementById('welcome').textContent = 'Hai, ' + name;
    });

    // Elemen UI
    const openBtn = document.getElementById('openPwd');
    const bd = document.getElementById('pwdBackdrop');
    const cancelBtn = document.getElementById('pwdCancel');
    const saveBtn = document.getElementById('pwdSave');
    const st = document.getElementById('pwdStatus');
    const spin = document.getElementById('pwdSpin');

    const curr = document.getElementById('currPwd');
    const np = document.getElementById('newPwd');
    const np2 = document.getElementById('newPwd2');

    function openModal(){
      st.textContent=''; st.className='status';
      curr.value=''; np.value=''; np2.value='';
      bd.classList.add('show');
      setTimeout(()=>curr.focus(), 50);
    }
    function closeModal(){ bd.classList.remove('show'); }

    openBtn.addEventListener('click', openModal);
    cancelBtn.addEventListener('click', closeModal);
    bd.addEventListener('click', (e)=>{ if (e.target===bd) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && bd.classList.contains('show')) closeModal(); });

    // Peta mesej dari server â†’ mesej mesra pengguna
    const msgMap = {
      'KATA LALUAN SALAH':'Kata laluan semasa salah.',
      'AKAUN TIADA':'Akaun tidak ditemui.',
      'LEMAH_MIN8':'Kata laluan baharu mesti â‰¥ 8 aksara.',
      'MEDAN_TAK_LENGKAP':'Lengkapkan semua medan.',
      'NOT_AUTH':'Sesi tamat. Sila login semula.',
      'UNKNOWN_ACTION':'Server belum dikemas kini (tiada changePassword).',
      'NO_MESSAGE':'Permintaan dihantar. Jika tiada respons, cuba semula.'
    };

    async function handleSave(){
      st.textContent=''; st.className='status';
      const oldPw = curr.value.trim();
      const newPw = np.value.trim();
      const newPw2 = np2.value.trim();

      if (!oldPw || !newPw || !newPw2){
        st.textContent='Lengkapkan semua medan.'; st.className='status err'; return;
      }
      if (newPw.length < 8){
        st.textContent='Kata laluan baharu mesti â‰¥ 8 aksara.'; st.className='status err'; return;
      }
      if (newPw !== newPw2){
        st.textContent='Pengesahan tidak sepadan.'; st.className='status err'; return;
      }

      saveBtn.disabled = true; spin.classList.add('show');

      // Panggil Apps Script melalui auth.js helper
      if (!WFH.changePassword){
        // fallback kalau auth.js lama
        saveBtn.disabled=false; spin.classList.remove('show');
        st.textContent = 'Fungsi changePassword tiada dalam auth.js. Pastikan fail auth.js terkini.'; 
        st.className='status err';
        return;
      }

      WFH.changePassword(oldPw, newPw, (res)=>{
        saveBtn.disabled = false; spin.classList.remove('show');

        if (res && res.ok){
          st.textContent='Kata laluan berjaya ditukar. Sila guna kata laluan baharu untuk login selepas ini.'; 
          st.className='status ok';
          setTimeout(closeModal, 1200);
          return;
        }

        // Papar sebab sebenar jika ada
        const msgKey = res && res.message ? String(res.message) : '';
        const friendly = msgMap[msgKey] || 'Gagal menukar kata laluan. Cuba lagi.';
        st.textContent = friendly; st.className='status err';

        // Jika sesi tamat â†’ paksa login semula
        if (msgKey === 'NOT_AUTH'){
          setTimeout(()=>{ location.href = 'login.html'; }, 1200);
        }
      });
    }

    saveBtn.addEventListener('click', handleSave);
  </script>
</body>
</html>
