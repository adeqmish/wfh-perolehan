<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kelulusan Perolehan – WFH</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#9fb0ff;--accent:#4da3ff;--ok:#34d399;--err:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#0b1020,#0e1429 40%,#0b1020);font-family:Inter,system-ui,Segoe UI,Arial;color:#e9eeff}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:40px;height:40px}
    .nav a,.nav button{margin-left:8px;padding:10px 14px;border-radius:12px;border:0;background:#4da3ff;color:#001333;font-weight:700;cursor:pointer;text-decoration:none}

    .wrap{max-width:980px;margin:20px auto;padding:16px}
    .card{background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 30px 120px rgba(0,0,0,.5);padding:20px}
    h2{margin:0 0 10px}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input[type="text"], input[type="file"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c132a;color:#e9eeff}
    .actions{display:flex;gap:10px;align-items:center;margin-top:14px}
    .btn{padding:10px 14px;border:0;border-radius:12px;background:var(--accent);color:#001333;font-weight:700;cursor:pointer}
    .status{margin-top:8px}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--err)}

    .list{margin-top:18px;max-height:380px;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .td-actions{display:flex;gap:8px;flex-wrap:wrap}

    /* Loading */
    .loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.72);backdrop-filter:blur(4px);z-index:70}
    .loading.show{display:flex}
    .loading-box{width:min(92%,420px);text-align:center;background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:26px 22px;box-shadow:0 30px 120px rgba(0,0,0,.6)}
    .spinner{width:54px;height:54px;border-radius:50%;margin:0 auto 12px;border:6px solid rgba(255,255,255,.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://bursary.unisel.edu.my/wp-content/uploads/sites/15/2024/05/cropped-unisel-2.png" alt="UNISEL"/>
      <div>
        <div style="font-weight:700">WFH – Kelulusan Perolehan</div>
        <small id="welcome" class="muted"></small>
      </div>
    </div>
    <div class="nav">
      <a href="dashboard.html">Home</a>
      <a href="kelulusan-bendahari.html">Bendahari</a>
      <a href="kelulusan-nc.html">Naib Canselor</a>
      <a href="laporan-perolehan.html">Laporan</a>
      <button onclick="WFH.logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h2>Kelulusan Perolehan</h2>
      <p class="muted">Masukkan No Purchase Order (PO), muat naik dokumen (PDF), kemudian tekan <b>Submit</b>. Selepas submit, borang akan kosong semula dan status muncul di bawah.</p>

      <label for="poNo">No Purchase Order (PO)</label>
      <input id="poNo" type="text" placeholder="cth: 01-PO202500362" autocomplete="off" required>

      <label for="poDoc">Upload Dokumen (PDF)</label>
      <input id="poDoc" type="file" accept="application/pdf" required>

      <div class="actions">
        <button id="btnSubmit" class="btn">Submit</button>
        <div id="stat" class="status"></div>
      </div>

      <h3 style="margin-top:18px">Status Purchase Order (PO)</h3>
      <div class="list">
        <table>
          <thead>
          <tr>
            <th style="width:24%">No PO</th>
            <th>Status</th>
            <th>Tarikh Bendahari Submit</th>
            <th>Tarikh NC Submit</th>
            <th style="width:1%">Tindakan</th>
          </tr>
          </thead>
          <tbody id="tbody"><tr><td colspan="5" class="muted">Memuatkan…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="loading" class="loading" aria-live="polite" aria-busy="true">
    <div class="loading-box">
      <div class="spinner" aria-hidden="true"></div>
      <h4>Memproses…</h4>
      <p id="loading-msg">Menghantar data</p>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    const setStat=(m,ok)=>{ const el=document.getElementById('stat'); el.textContent=m||''; el.className='status '+(ok?'ok':'err'); };
    const loading=document.getElementById('loading');
    const loadingMsg=document.getElementById('loading-msg');
    const showLoading=(m)=>{ if(m) loadingMsg.textContent=m; loading.classList.add('show'); };
    const hideLoading=()=> loading.classList.remove('show');

    WFH.ensureAuth((res)=>{
      document.getElementById('welcome').textContent = 'Log masuk sebagai ' + (localStorage.getItem('wfh_name')||res.email);
      renderList();
    });

    document.getElementById('btnSubmit').addEventListener('click', async ()=>{
      const poNo = document.getElementById('poNo').value.trim();
      const file = document.getElementById('poDoc').files[0];
      if(!poNo){ setStat('Isi No PO.', false); return; }
      if(!file || file.type!=='application/pdf'){ setStat('Muat naik 1 dokumen PDF.', false); return; }
      try{
        showLoading('Memuat naik dokumen');
        const b64 = await file.arrayBuffer().then(buf=>{
          let bin=''; const bytes=new Uint8Array(buf); const chunk=0x8000;
          for(let i=0;i<bytes.length;i+=chunk){ bin += String.fromCharCode.apply(null, bytes.subarray(i,i+chunk)); }
          return btoa(bin);
        });
        WFH.poSubmit(poNo, b64, (r)=>{
          hideLoading();
          if(r && r.ok){
            setStat('Berjaya hantar.', true);
            document.getElementById('poNo').value='';
            document.getElementById('poDoc').value='';
            renderList();
          }else{
            setStat(r && r.message ? r.message : 'Gagal hantar.', false);
          }
        });
      }catch(e){ hideLoading(); setStat('Ralat fail.', false); }
    });

    function renderList(){
      WFH.poListStatus((r)=>{
        const tb=document.getElementById('tbody');
        tb.innerHTML='';
        if(!r || !r.ok || !Array.isArray(r.items) || !r.items.length){
          tb.innerHTML = '<tr><td colspan="5" class="muted">Tiada rekod.</td></tr>';
          return;
        }
        r.items.forEach(row=>{
          const tr=document.createElement('tr');
          const statusTxt = row.status === 'MENUNGGU_BENDAHARI' ? 'Menunggu Kelulusan Bendahari' :
                            row.status === 'MENUNGGU_NC' ? `Menunggu Kelulusan Naib Canselor` :
                            row.status === 'LULUS_NC' ? 'Lulus Naib Canselor' : row.status;
          tr.innerHTML = `<td>${row.poNo}</td>
                          <td>${statusTxt}</td>
                          <td>${row.bendahariAt||'-'}</td>
                          <td>${row.ncAt||'-'}</td>
                          <td></td>`;
          const td = tr.lastElementChild; td.className='td-actions';
          if(row.status==='LULUS_NC'){
            if(row.ncUrl){
              const a=document.createElement('a'); a.textContent='Download'; a.className='btn'; a.href=row.ncUrl; a.target='_blank'; td.appendChild(a);
            }
            const b=document.createElement('button'); b.className='btn'; b.textContent='Complete';
            b.onclick=()=>{ if(!confirm('Tanda sebagai Selesai? Rekod akan dikeluarkan dari senarai ini.')) return;
              WFH.poComplete(row.id, ()=>{ renderList(); });
            };
            td.appendChild(b);
          }
          tb.appendChild(tr);
        });
      });
    }
  </script>
</body>
</html>
