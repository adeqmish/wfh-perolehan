<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Perolehan (PR)– AKABAH</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#9fb0ff;--accent:#4da3ff;--ok:#34d399;--err:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#0b1020,#0e1429 40%,#0b1020);color:#e9eeff;min-height:100vh}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px}
    .brand{display:flex;align-items:center;gap:10px}
    /* elak stretch: kekal nisbah asal */
.brand img{
  height: 36px;     /* boleh tukar 32–40 ikut sedap mata */
  width: auto;      /* biar lebar ikut nisbah */
  max-width: 160px; /* elak terlalu panjang kalau logo melintang */
  display: block;   /* elak “jump” inline */
}
@media (max-width: 480px){
  .brand img{ height: 30px; }  /* kecilkan sikit di mobile */
}

    .nav a,.nav button{margin-left:8px;padding:10px 14px;border-radius:12px;border:0;background:var(--accent);color:#001333;font-weight:700;cursor:pointer;text-decoration:none}

    .wrap{max-width:1200px;margin:20px auto;padding:16px}
    .grid{display:grid;grid-template-columns: 380px 1fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 30px 120px rgba(0,0,0,.5);padding:18px}
    h2{margin:2px 0 10px}
    .muted{color:#b8c7ff}

    /* LEFT: Summary list */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .toolbar input[type="text"]{flex:1 1 240px;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c132a;color:#e9eeff}
    .count{margin-left:auto;color:#9fb0ff;font-size:13px}
    .list{display:grid;gap:10px;max-height:66vh;overflow:auto;padding-right:4px}
    .row{display:flex;align-items:center;gap:8px;justify-content:space-between;background:#0c132a;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;cursor:pointer}
    .row:hover{border-color:#4da3ff}
    .pr{font-weight:700}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0e1733;border:1px solid rgba(255,255,255,.08);border-radius:40px;padding:6px 10px;font-size:12px;color:#cfd8ff}
    .empty{padding:18px;border:1px dashed rgba(255,255,255,.15);border-radius:14px;text-align:center;color:#9fb0ff}

    /* RIGHT: Detail/timeline */
    .detail{min-height:260px}
    .title{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .stageNow{display:inline-flex;align-items:center;gap:6px;background:#14224d;border:1px solid rgba(255,255,255,.12);border-radius:40px;padding:8px 12px}
    .timeline{margin-top:14px;border-left:2px solid rgba(255,255,255,.12);padding-left:14px;display:grid;gap:14px}
    .event{position:relative;background:#0c132a;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    .event::before{content:'';position:absolute;left:-19px;top:12px;width:10px;height:10px;border-radius:50%;background:#4da3ff;border:2px solid #19244a}
    .event .meta{font-size:12px;color:#b8c7ff;margin-top:6px}
    .event a.btn{display:inline-block;margin-top:8px;padding:8px 10px;border-radius:10px;border:0;background:#243055;color:#dbe6ff;text-decoration:none}
    .event a.btn:hover{background:#2b3a6a}

    .status{font-size:13px;margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}

    /* Loading Overlay */
    .loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.72);backdrop-filter:blur(4px);z-index:70}
    .loading.show{display:flex}
    .loading-box{width:min(92%,420px);text-align:center;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:26px 22px;box-shadow:0 30px 120px rgba(0,0,0,.6)}
    .spinner{width:54px;height:54px;border-radius:50%;margin:0 auto 12px;border:6px solid rgba(255,255,255,.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://bursary.unisel.edu.my/wp-content/uploads/sites/15/2024/05/cropped-unisel-2.png" alt="UNISEL"/>
      <div>
        <div style="font-weight:700">Laporan Perolehan (PR)</div>
        <small id="welcome" class="muted"></small>
      </div>
    </div>
    <div class="nav">
      <a href="dashboard.html">Home</a>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT: Summary list -->
      <section class="card">
        <h2>Senarai PR (Status Terkini)</h2>
        <p class="muted">Klik PR untuk lihat timeline & muat turun dokumen setiap peringkat.</p>
        <div class="toolbar">
          <input id="search" type="text" placeholder="Cari PR No…" />
          <div class="count"><span id="count">0</span> item</div>
        </div>
        <div id="list" class="list" aria-live="polite"></div>
        <div id="empty" class="empty" style="display:none">Tiada data.</div>
      </section>

      <!-- RIGHT: Detail -->
      <section class="card detail">
        <div id="placeholder">
          <h2>Timeline Dokumen</h2>
          <p class="muted">Pilih mana-mana PR di sebelah kiri untuk lihat pergerakan dokumen & muat turun fail.</p>
        </div>

        <div id="detailBox" style="display:none">
          <div class="title">
            <h2 id="headPr" style="margin:0">PR —</h2>
            <div id="headStage" class="stageNow">Stage Terkini: —</div>
          </div>
          <div class="timeline" id="timeline"></div>
          <div id="status" class="status"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div id="loading" class="loading" aria-live="polite" aria-busy="true">
    <div class="loading-box">
      <div class="spinner" aria-hidden="true"></div>
      <h4>Memproses…</h4>
      <p id="loading-msg">Memuatkan laporan</p>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    // ===== Shortcuts
    const el = (id)=>document.getElementById(id);
    const listEl = el('list'), emptyEl = el('empty'), countEl = el('count');
    const searchEl = el('search'), loading = el('loading'), loadingMsg = el('loading-msg');
    const placeholder = el('placeholder'), detailBox = el('detailBox'), headPr = el('headPr'), headStage = el('headStage'), timeline = el('timeline'), statusEl = el('status');

    function showLoading(msg){ if (msg) loadingMsg.textContent = msg; loading.classList.add('show'); }
    function hideLoading(){ loading.classList.remove('show'); }
    function setStatus(msg, ok){ statusEl.textContent = msg||''; statusEl.className = 'status ' + (ok ? 'ok' : (msg?'err':'')); }

    let SUMMARY = []; // dari listlaporan (summary)
    let FILTERED = [];

    // ===== Auth & Load summary
  document.addEventListener('DOMContentLoaded', ()=>{
    const name = localStorage.getItem('wfh_name') || localStorage.getItem('wfh_email') || '';
    const token = WFH.getToken();
    if (!token) { location.href = 'login.html'; return; }

    document.getElementById('welcome').textContent = 'Log masuk sebagai ' + name;

    // (pilihan) Warm-up non-blocking – biar server “bangun” sementara user nampak UI
    WFH.postViaIframe('__echo', {}, ()=>{});

    // Terus panggil data (server akan verify token juga)
    loadList();
  });

    function loadSummary(){
      showLoading('Memuatkan ringkasan PR…');
      WFH.postViaIframe('listlaporan', { token: WFH.getToken() }, (r)=>{
        hideLoading();
        if (!r || !r.ok || !Array.isArray(r.summary)){
          SUMMARY = []; renderList(); return;
        }
        // item: {prNo, stage, byEmail, fileUrl, fileName, fileId}
        SUMMARY = r.summary.slice().sort((a,b)=> (a.prNo||'').localeCompare(b.prNo||''));
        renderList();
      });
    }

    function renderList(){
      const q = (searchEl.value||'').trim().toLowerCase();
      FILTERED = SUMMARY.filter(x => !q || String(x.prNo||'').toLowerCase().includes(q));
      listEl.innerHTML = '';
      countEl.textContent = FILTERED.length;
      if (!FILTERED.length){ emptyEl.style.display='block'; return; }
      emptyEl.style.display='none';

      FILTERED.forEach(item=>{
        const row = document.createElement('div');
        row.className = 'row';
        row.addEventListener('click', ()=> openDetail(item.prNo));

        const left = document.createElement('div');
        left.style.display='grid';
        left.style.gap='4px';
        const pr = document.createElement('div'); pr.className='pr'; pr.textContent = item.prNo || '(tiada PR)';
        const who = document.createElement('div'); who.className='muted'; who.textContent = 'Terakhir oleh: ' + (item.byEmail || '-');
        left.append(pr, who);

        const right = document.createElement('div');
        const stage = document.createElement('div'); stage.className='pill'; stage.innerHTML = 'Stage: <b>'+ (item.stage||'-') +'</b>';
        right.append(stage);

        row.append(left, right);
        listEl.appendChild(row);
      });
    }

    searchEl.addEventListener('input', renderList);

    function openDetail(prNo){
      placeholder.style.display='none';
      detailBox.style.display='block';
      headPr.textContent = 'PR ' + prNo;
      headStage.textContent = 'Stage Terkini: —';
      timeline.innerHTML = '';
      setStatus('', true);

      showLoading('Memuatkan timeline untuk '+prNo+'…');
      WFH.postViaIframe('listlaporan', { token: WFH.getToken(), prNo }, (r)=>{
        hideLoading();
        if (!r || !r.ok || !Array.isArray(r.history)){
          setStatus('Gagal memuatkan timeline.', false); return;
        }
        const hist = r.history; // [{stage, byEmail, fileUrl, fileName, createdAt}]
        if (!hist.length){ setStatus('Tiada rekod untuk PR ini.', false); return; }

        // Stage terkini
        const latest = hist[hist.length-1];
        headStage.textContent = 'Stage Terkini: ' + (latest.stage || '-');

        // Bina event/timeline
        timeline.innerHTML = '';
        hist.forEach(ev=>{
          const box = document.createElement('div');
          box.className = 'event';
          const title = document.createElement('div');
          title.innerHTML = '<b>'+ (ev.stage || '-') +'</b>';
          const meta = document.createElement('div');
          const dt = ev.createdAt ? new Date(ev.createdAt) : null;
          meta.className = 'meta';
          meta.textContent = (ev.byEmail||'-') + (dt ? (' · ' + dt.toLocaleString()) : '');

          const dl = document.createElement('a');
          dl.className = 'btn';
          dl.target = '_blank';
          dl.href = ev.fileUrl || '#';
          dl.textContent = '⬇️ Muat Turun Dokumen (' + (ev.stage||'-') + ')';

          box.append(title, meta, dl);
          timeline.appendChild(box);
        });

        setStatus('Selesai.', true);
      });
    }
  </script>
</body>
</html>
